---
phase: 04-ending-flow
plan: "02"
type: execute
wave: 1
depends_on:
  - "04-01"
files_modified:
  - src/ServerScriptService/Services/NPCBehaviorRunner.lua
  - src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua
  - src/ServerScriptService/Services/AnomalyEventService.lua
  - src/ServerScriptService/Main.server.lua
  - src/ServerScriptService/Services/EndingService.lua
autonomous: true
must_haves:
  truths:
    - "Trigger dipukul TungTung Sahur benar-benar menyetel flag ending ke player aktif."
    - "Trigger portal tersembunyi dapat menyetel flag ending dari pipeline anomali."
    - "Ending resolver membaca flag runtime dan mengembalikan kode easter egg valid."
  artifacts:
    - path: src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua
      provides: "Bridge trigger meme ke flag ending"
    - path: src/ServerScriptService/Services/AnomalyEventService.lua
      provides: "Bridge trigger portal ke flag ending"
  key_links:
    - from: src/ServerScriptService/Services/NPCBehaviorRunner.lua
      to: src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua
      via: "behavior context menyediakan helper set flag player"
    - from: src/ServerScriptService/Services/AnomalyEventService.lua
      to: src/ServerScriptService/Services/EndingService.lua
      via: "event anomaly meng-set portal flag"
---

<objective>
Menghubungkan trigger runtime gameplay ke ending resolver.

Purpose: Menjamin easter egg ending bisa tercapai secara valid dari aksi di game.
Output: Integrasi trigger flag TungTung/portal + wiring service dependencies.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ending-flow/04-CONTEXT.md
@.planning/phases/04-ending-flow/04-RESEARCH.md
@.planning/phases/04-ending-flow/04-01-SUMMARY.md
@src/ServerScriptService/Services/NPCBehaviorRunner.lua
@src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua
@src/ServerScriptService/Services/AnomalyEventService.lua
@src/ServerScriptService/Services/EndingService.lua
@src/ServerScriptService/Main.server.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tambah helper set ending flag ke behavior context</name>
  <files>src/ServerScriptService/Services/NPCBehaviorRunner.lua, src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua</files>
  <action>Inject helper context pada runner untuk menyetel flag player aktif via EndingService/Economy. Ubah handler `bonk_player_for_event` agar benar-benar memanggil helper set flag `wasHitByTungTung`.</action>
  <verify>Handler TungTung tidak hanya set attribute NPC, tapi juga set flag player aktif.</verify>
  <done>Trigger easter egg TungTung valid dari jalur behavior runtime.</done>
</task>

<task type="auto">
  <name>Task 2: Integrasi hidden portal trigger dari anomaly pipeline</name>
  <files>src/ServerScriptService/Services/AnomalyEventService.lua, src/ServerScriptService/Services/EndingService.lua</files>
  <action>Tambahkan kondisi portal tersembunyi (mis. chance setelah anomaly response success) yang menyetel flag `enteredHiddenPortal` melalui EndingService. Kirim warning payload agar bisa diinspeksi client.</action>
  <verify>Jalur TriggerAnomalyEvent memiliki branch yang dapat set flag portal secara aman.</verify>
  <done>Trigger easter egg portal terhubung ke gameplay event anomali.</done>
</task>

<task type="auto">
  <name>Task 3: Wire runtime service dependencies untuk ending triggers</name>
  <files>src/ServerScriptService/Main.server.lua</files>
  <action>Pastikan Main menginjeksi dependency ending service ke behavior runner dan anomaly service secara eksplisit. Pastikan remote EndingTriggered tersedia di server remotes folder untuk notifikasi resolver.</action>
  <verify>Bootstrap service menunjukkan ending dependency terhubung ke runner dan anomaly pipeline.</verify>
  <done>Trigger runtime -> flag -> resolver ending terhubung end-to-end.</done>
</task>

</tasks>

<verification>
- [ ] Flag `wasHitByTungTung` bisa terset via behavior meme runtime.
- [ ] Flag `enteredHiddenPortal` bisa terset via event anomali runtime.
- [ ] Resolver ending membaca flag dan memilih kode easter egg dengan benar.
</verification>

<success_criteria>
- END-02 dan END-03 terpenuhi via trigger gameplay nyata.
- Branch ending siap dipakai oleh phase UI feedback untuk presentasi ke pemain.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ending-flow/04-02-SUMMARY.md`
</output>
