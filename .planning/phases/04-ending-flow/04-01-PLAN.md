---
phase: 04-ending-flow
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ServerScriptService/Services/EndingService.lua
  - src/ServerScriptService/Services/GameDirector.lua
  - src/ReplicatedStorage/Shared/Remotes/RemoteNames.lua
autonomous: true
must_haves:
  truths:
    - "Main ending aktif saat pemain survive hari ke-7 tanpa game over."
    - "Easter egg ending TungTung dan portal diprioritaskan di atas main ending."
    - "Flag dan unlock ending tercatat aman per pemain."
  artifacts:
    - path: src/ServerScriptService/Services/EndingService.lua
      provides: "Ending resolver terstruktur + metadata + unlock tracking."
  key_links:
    - from: src/ServerScriptService/Services/GameDirector.lua
      to: src/ServerScriptService/Services/EndingService.lua
      via: "EndDay memanggil ending resolver"
---

<objective>
Mengeraskan EndingService agar siap dipakai runtime branch ending.

Purpose: Menjamin kondisi ending dievaluasi konsisten dan tercatat.
Output: EndingService modular dengan metadata ending, priority resolver, dan flag helper.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ending-flow/04-CONTEXT.md
@.planning/phases/04-ending-flow/04-RESEARCH.md
@src/ServerScriptService/Services/EndingService.lua
@src/ServerScriptService/Services/GameDirector.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor EndingService ke declarative definitions</name>
  <files>src/ServerScriptService/Services/EndingService.lua</files>
  <action>Buat tabel definisi ending yang memuat code/title/priority/condition. Resolver membaca definisi berdasar prioritas dan mengembalikan ending code valid pertama.</action>
  <verify>ResolveEnding tidak lagi hardcode if-chain tunggal; memakai definisi ending terstruktur.</verify>
  <done>Ending rules lebih mudah ditambah tanpa merombak service.</done>
</task>

<task type="auto">
  <name>Task 2: Tambah flag bridge dan unlock tracking</name>
  <files>src/ServerScriptService/Services/EndingService.lua</files>
  <action>Tambahkan API `RecordFlag`, `GetEndingDefinition`, `GetUnlockedEndings`, dan penyimpanan `lastEndingCode`/unlock flag ke economy. Pastikan semua jalur fail-safe jika data pemain belum ada.</action>
  <verify>Service memiliki API helper flag/unlock dan tetap aman saat player/economy nil.</verify>
  <done>Flag ending bisa diupdate runtime dan status unlock dapat di-query.</done>
</task>

<task type="auto">
  <name>Task 3: Integrasi resolusi ending dengan notifikasi best-effort</name>
  <files>src/ServerScriptService/Services/EndingService.lua, src/ServerScriptService/Services/GameDirector.lua, src/ReplicatedStorage/Shared/Remotes/RemoteNames.lua</files>
  <action>Tambahkan hook notifikasi ending (remote optional) saat ending resolved dan hindari spam notifikasi duplikat dalam satu sesi. Pastikan kontrak `ResolveEnding` tetap kompatibel dengan caller GameDirector.</action>
  <verify>GameDirector tetap bisa memanggil ResolveEnding dan EndingService punya jalur notify non-fatal.</verify>
  <done>Ending resolved terpublikasi aman tanpa merusak game loop.</done>
</task>

</tasks>

<verification>
- [ ] Priority resolver: easter egg > main ending.
- [ ] Flag `lastEndingCode` dan unlock ending tersimpan.
- [ ] Notifikasi ending bersifat best-effort dan tidak crash jika remote hilang.
</verification>

<success_criteria>
- END-01 terpenuhi secara deterministic.
- Fondasi END-02/END-03 siap untuk trigger runtime plan berikutnya.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ending-flow/04-01-SUMMARY.md`
</output>
