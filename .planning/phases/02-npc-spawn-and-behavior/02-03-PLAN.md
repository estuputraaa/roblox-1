---
phase: 02-npc-spawn-and-behavior
plan: "03"
type: execute
wave: 2
depends_on:
  - "02-01"
  - "02-02"
files_modified:
  - src/ServerScriptService/Services/NPCBehaviorRunner.lua
  - src/ServerScriptService/Services/NPCBehaviors/NormalBehaviors.lua
  - src/ServerScriptService/Services/NPCBehaviors/AnomalyBehaviors.lua
  - src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua
  - src/ServerScriptService/Services/NPCSpawner.lua
  - src/ServerScriptService/Main.server.lua
autonomous: true
must_haves:
  truths:
    - "NPC normal, anomali, dan meme menjalankan behavior type yang berbeda."
    - "NPC memiliki hook animasi minimal idle/walk/emote saat spawn."
    - "Jika animasi/behavior gagal, sistem fallback aman tanpa crash spawn loop."
  artifacts:
    - path: src/ServerScriptService/Services/NPCBehaviorRunner.lua
      provides: "Router behavior type + animation playback hooks."
    - path: src/ServerScriptService/Services/NPCBehaviors/NormalBehaviors.lua
      provides: "Handler behavior NPC normal."
    - path: src/ServerScriptService/Services/NPCBehaviors/AnomalyBehaviors.lua
      provides: "Handler behavior NPC anomali."
    - path: src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua
      provides: "Handler behavior NPC meme."
  key_links:
    - from: src/ServerScriptService/Services/NPCSpawner.lua
      to: src/ServerScriptService/Services/NPCBehaviorRunner.lua
      via: "spawner memanggil runner setelah NPC clone berhasil"
    - from: src/ServerScriptService/Services/NPCBehaviorRunner.lua
      to: src/ServerScriptService/Services/NPCBehaviors/*
      via: "behavior.type diroute ke handler class/module"
---

<objective>
Menyelesaikan integrasi behavior runtime dan animasi hook untuk semua kategori NPC.

Purpose: Menjamin NPC tidak hanya spawn, tapi juga bertindak sesuai tipe dan tone game.
Output: Behavior runner modular + class behavior handlers + animation-safe integration.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-npc-spawn-and-behavior/02-CONTEXT.md
@.planning/phases/02-npc-spawn-and-behavior/02-RESEARCH.md
@.planning/phases/02-npc-spawn-and-behavior/02-01-SUMMARY.md
@.planning/phases/02-npc-spawn-and-behavior/02-02-SUMMARY.md
@src/ServerScriptService/Services/NPCSpawner.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement NPCBehaviorRunner + animation hook engine</name>
  <files>src/ServerScriptService/Services/NPCBehaviorRunner.lua</files>
  <action>Buat service runner yang menerima `npcModel` + `npcData`, lalu: setup animator, load animation ids idle/walk/emote secara safe (pcall), dan expose API `RunBehavior`. Tambahkan fallback warning jika animation asset gagal load, tetapi jangan hentikan behavior execution.</action>
  <verify>Periksa runner memiliki jalur `RunBehavior` dan helper animation load/play yang tidak melempar error fatal.</verify>
  <done>Behavior runner siap dipanggil spawner untuk semua NPC kelas.</done>
</task>

<task type="auto">
  <name>Task 2: Tambah behavior modules per kategori NPC</name>
  <files>src/ServerScriptService/Services/NPCBehaviors/NormalBehaviors.lua, src/ServerScriptService/Services/NPCBehaviors/AnomalyBehaviors.lua, src/ServerScriptService/Services/NPCBehaviors/MemeBehaviors.lua</files>
  <action>Buat handler modular per kategori yang memetakan `behavior.type` ke aksi baseline (set attribute state, target role, atau trigger ringan). Pastikan setiap module mengembalikan status eksekusi dan tidak crash saat type tidak dikenal (fallback no-op + warning).</action>
  <verify>Setiap module mengekspor fungsi route/execute behavior dan menangani unknown type secara aman.</verify>
  <done>Behavior class-specific tersedia untuk normal, anomali, dan meme.</done>
</task>

<task type="auto">
  <name>Task 3: Integrasi runner ke NPCSpawner dan bootstrap</name>
  <files>src/ServerScriptService/Services/NPCSpawner.lua, src/ServerScriptService/Main.server.lua</files>
  <action>Inject NPCBehaviorRunner ke NPCSpawner melalui constructor/options, lalu ganti `_applyBehavior` agar memanggil runner. Pastikan NPC spawn yang valid selalu melalui jalur behavior + animasi hook, dengan fallback tetap spawn jika behavior gagal.</action>
  <verify>Review jalur spawn menunjukkan runner dipanggil setelah clone model, dan kegagalan behavior tidak memutus loop spawn.</verify>
  <done>Spawn, behavior, dan animasi terintegrasi end-to-end pada runtime phase 2.</done>
</task>

</tasks>

<verification>
- [ ] Runner behavior dan module kategori terhubung ke spawner.
- [ ] Hook animasi idle/walk/emote dipanggil aman.
- [ ] Unknown behavior/anim failure fallback ke warning, bukan crash.
</verification>

<success_criteria>
- NPC kategori berbeda menunjukkan behavior path berbeda.
- Kontrak animasi dasar terpenuhi untuk semua NPC valid.
- Sistem phase 2 siap jadi fondasi mini-game/event phase 3.
</success_criteria>

<output>
After completion, create `.planning/phases/02-npc-spawn-and-behavior/02-03-SUMMARY.md`
</output>
