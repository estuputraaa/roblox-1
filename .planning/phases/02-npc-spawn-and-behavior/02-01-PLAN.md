---
phase: 02-npc-spawn-and-behavior
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ReplicatedStorage/Shared/Config/NPCBehaviorConfig.lua
  - src/ServerScriptService/Services/NPCConfigValidator.lua
  - src/ServerScriptService/Services/NPCSpawner.lua
autonomous: true
must_haves:
  truths:
    - "Spawn profile Day/Night/EventAnomaly tervalidasi sebelum runtime spawn dipakai."
    - "Config NPC invalid tidak crash server dan diperlakukan sebagai skipped entry."
    - "Sistem tetap bisa memilih NPC valid dari config yang lolos validasi."
  artifacts:
    - path: src/ServerScriptService/Services/NPCConfigValidator.lua
      provides: "Schema validation + normalization untuk NPC config."
    - path: src/ReplicatedStorage/Shared/Config/NPCBehaviorConfig.lua
      provides: "Data NPC + profile yang konsisten untuk runtime."
    - path: src/ServerScriptService/Services/NPCSpawner.lua
      provides: "Integrasi validator di pipeline pemilihan NPC."
  key_links:
    - from: src/ServerScriptService/Services/NPCSpawner.lua
      to: src/ServerScriptService/Services/NPCConfigValidator.lua
      via: "validator dipanggil saat init spawner"
---

<objective>
Mengunci kualitas data NPC config dengan validator server-side.

Purpose: Mencegah runtime issue dari typo/missing field di config data-driven.
Output: Validator module + spawner integration + config hardening.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-npc-spawn-and-behavior/02-CONTEXT.md
@.planning/phases/02-npc-spawn-and-behavior/02-RESEARCH.md
@src/ReplicatedStorage/Shared/Config/NPCBehaviorConfig.lua
@src/ServerScriptService/Services/NPCSpawner.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hardening struktur data NPCBehaviorConfig</name>
  <files>src/ReplicatedStorage/Shared/Config/NPCBehaviorConfig.lua</files>
  <action>Rapikan config agar eksplisit memiliki metadata schema version, daftar class yang didukung, dan aturan default profile. Pastikan profile Day/Night/EventAnomaly ada dan nilai Night tetap balanced untuk normal vs anomali. Jangan ubah intent karakter NPC yang sudah ditetapkan pengguna.</action>
  <verify>Pastikan config masih dapat di-require dan key utama tersedia: SpawnProfiles, NPCs, SupportedClasses.</verify>
  <done>Config memiliki struktur yang siap divalidasi dan mudah dituning.</done>
</task>

<task type="auto">
  <name>Task 2: Implement NPCConfigValidator module</name>
  <files>src/ServerScriptService/Services/NPCConfigValidator.lua</files>
  <action>Buat validator yang mengecek profile keys, class weights, field wajib per NPC (id, class, spawnWeight, modelName, animations, behavior.type), serta nilai numerik minimum. Validator harus mengembalikan hasil normalized + daftar warnings untuk item invalid yang di-skip tanpa menghentikan server.</action>
  <verify>Periksa module mengekspor fungsi validasi yang menghasilkan object dengan minimal: isValid, normalizedConfig, warnings.</verify>
  <done>Validator dapat memfilter config invalid secara aman.</done>
</task>

<task type="auto">
  <name>Task 3: Integrasikan validator ke NPCSpawner init flow</name>
  <files>src/ServerScriptService/Services/NPCSpawner.lua</files>
  <action>Update constructor NPCSpawner agar melakukan validasi config di startup. Gunakan config normalized hasil validator untuk semua weighted pick runtime. Jika ada warnings, emit warn terstruktur. Jika tidak ada NPC valid sama sekali, fail-safe dengan return nil tanpa crash.</action>
  <verify>Review jalur SelectNPC memastikan menggunakan config normalized, bukan raw config langsung.</verify>
  <done>Spawner hanya beroperasi pada data config yang sudah tervalidasi.</done>
</task>

</tasks>

<verification>
- [ ] Validator module tersedia dan dipanggil di init spawner.
- [ ] Config invalid diperingatkan dan di-skip aman.
- [ ] Spawn selection tetap berjalan untuk NPC valid.
</verification>

<success_criteria>
- Fondasi data-driven spawn aman dari config corruption.
- Runtime spawn tidak crash oleh entry NPC yang salah format.
- Day/Night/EventAnomaly profiles tetap tersedia untuk phase lanjut.
</success_criteria>

<output>
After completion, create `.planning/phases/02-npc-spawn-and-behavior/02-01-SUMMARY.md`
</output>
