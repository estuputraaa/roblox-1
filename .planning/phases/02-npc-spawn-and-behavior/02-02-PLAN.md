---
phase: 02-npc-spawn-and-behavior
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ServerScriptService/Services/NPCSpawner.lua
  - src/ServerScriptService/Services/GameDirector.lua
  - src/ServerScriptService/Main.server.lua
autonomous: true
must_haves:
  truths:
    - "Spawner memilih kelas NPC via weighted profile lalu memilih NPC spesifik via spawnWeight."
    - "Spawn rate dikontrol oleh cooldown profile/class dan global active cap."
    - "Spawn profile siang/malam/event dapat dipilih dan memengaruhi distribusi spawn."
  artifacts:
    - path: src/ServerScriptService/Services/NPCSpawner.lua
      provides: "Weighted spawn engine dengan cooldown/caps."
    - path: src/ServerScriptService/Services/GameDirector.lua
      provides: "Ekspos profile phase untuk sinkronisasi spawn."
    - path: src/ServerScriptService/Main.server.lua
      provides: "Wiring spawn tick terhadap state game."
  key_links:
    - from: src/ServerScriptService/Main.server.lua
      to: src/ServerScriptService/Services/NPCSpawner.lua
      via: "heartbeat loop memicu spawn attempts"
    - from: src/ServerScriptService/Services/NPCSpawner.lua
      to: src/ServerScriptService/Services/GameDirector.lua
      via: "profile spawn ditentukan dari phase/day state"
---

<objective>
Mengubah NPCSpawner menjadi engine spawn weighted yang terkontrol ritme.

Purpose: Menjamin distribusi spawn sesuai profile sambil menjaga performa runtime.
Output: spawn loop dengan class/NPC weighting, cooldowns, dan caps.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-npc-spawn-and-behavior/02-CONTEXT.md
@.planning/phases/02-npc-spawn-and-behavior/02-RESEARCH.md
@.planning/phases/02-npc-spawn-and-behavior/02-01-SUMMARY.md
@src/ServerScriptService/Services/NPCSpawner.lua
@src/ServerScriptService/Services/GameDirector.lua
@src/ServerScriptService/Main.server.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tambah cooldown dan cap policy di NPCSpawner</name>
  <files>src/ServerScriptService/Services/NPCSpawner.lua</files>
  <action>Tambahkan policy runtime: max active NPC global, max active per class, cooldown per profile/class, dan spawn throttle interval. Simpan timestamp spawn terakhir per class agar pemilihan spawn tetap terkendali saat heartbeat tinggi.</action>
  <verify>Periksa spawner memiliki guard check sebelum spawn clone dipanggil (active cap + cooldown pass).</verify>
  <done>Spawner menolak spawn berlebih dan menjaga ritme spawn stabil.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor API spawn untuk profile-aware scheduling</name>
  <files>src/ServerScriptService/Services/NPCSpawner.lua, src/ServerScriptService/Services/GameDirector.lua</files>
  <action>Buat API yang memungkinkan caller meminta spawn berdasarkan profile (`Day`, `Night`, `EventAnomaly`) dan fallback ke profile default dari state game. Tambahkan helper di GameDirector untuk memetakan fase aktif ke spawn profile agar alur siang/malam sinkron dengan distribusi NPC.</action>
  <verify>Pastikan ada jalur fungsi eksplisit untuk resolve profile dari state game sebelum SelectNPC dipanggil.</verify>
  <done>Spawn profile menjadi state-aware dan konsisten dengan fase harian.</done>
</task>

<task type="auto">
  <name>Task 3: Wire spawn attempts di Main heartbeat loop</name>
  <files>src/ServerScriptService/Main.server.lua</files>
  <action>Integrasikan spawn attempt ringan ke loop utama server: saat game state aktif dan budget spawn tersedia, panggil spawner dengan profile sesuai phase. Hindari spawn spam: gunakan interval check sederhana dan gagal diam saat constraints belum terpenuhi.</action>
  <verify>Review Main.server menunjukkan loop runtime memanggil spawner secara berkala dengan guard state/cooldown.</verify>
  <done>Runtime server secara otomatis menghasilkan NPC sesuai profile tanpa over-spawn.</done>
</task>

</tasks>

<verification>
- [ ] Weighted class + weighted NPC berjalan dari profile aktif.
- [ ] Cooldown/cap policy menahan over-spawn.
- [ ] Main runtime memicu spawn attempts secara terkendali.
</verification>

<success_criteria>
- Distribusi spawn profile siang/malam/event berjalan sesuai keputusan.
- NPC active count terjaga di batas aman.
- Fondasi spawn siap untuk behavior runner di plan berikutnya.
</success_criteria>

<output>
After completion, create `.planning/phases/02-npc-spawn-and-behavior/02-02-SUMMARY.md`
</output>
