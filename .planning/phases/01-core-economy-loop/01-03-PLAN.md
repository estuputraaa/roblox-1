---
phase: 01-core-economy-loop
plan: "03"
type: execute
wave: 2
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/ServerScriptService/Services/EconomyManager.lua
  - src/ServerScriptService/Services/GameDirector.lua
  - src/ServerScriptService/Services/MonetizationService.lua
  - src/ServerScriptService/Main.server.lua
  - src/ServerScriptService/Services/PersistenceService.lua
autonomous: true
must_haves:
  truths:
    - "Saat cash <= 0 kapan pun saat shift, fail flow langsung aktif."
    - "Player dapat memilih continue berbayar dengan efek hanya reset cash ke Rp100."
    - "Jika continue ditolak, player langsung diarahkan kembali ke lobby."
    - "Hook persistence tersedia untuk save state minimal end-of-day."
  artifacts:
    - path: src/ServerScriptService/Services/GameDirector.lua
      provides: "Fail trigger orchestration dan continue/decline flow."
      min_lines: 120
    - path: src/ServerScriptService/Services/MonetizationService.lua
      provides: "Continue purchase integration dan callback penerapan recovery."
      contains: "ProcessReceipt"
    - path: src/ServerScriptService/Services/PersistenceService.lua
      provides: "Placeholder service untuk load/save state player."
      min_lines: 40
  key_links:
    - from: src/ServerScriptService/Services/EconomyManager.lua
      to: src/ServerScriptService/Services/GameDirector.lua
      via: "callback saat saldo jatuh <= 0"
      pattern: "TriggerFail"
    - from: src/ServerScriptService/Services/MonetizationService.lua
      to: src/ServerScriptService/Services/EconomyManager.lua
      via: "apply continue recovery ke cash minimum 100"
      pattern: "AddCash|SetBalance|Recover"
    - from: src/ServerScriptService/Main.server.lua
      to: src/ServerScriptService/Services/PersistenceService.lua
      via: "bootstrap persistence hooks"
      pattern: "PersistenceService"
---

<objective>
Mengintegrasikan fail condition, continue flow berbayar, dan persistence placeholder.

Purpose: Menutup loop survive/fail Phase 1 agar run bisa selesai secara deterministic dengan jalur recovery yang jelas.
Output: Fail pipeline real-time + continue behavior + persistence hooks.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-economy-loop/01-CONTEXT.md
@.planning/phases/01-core-economy-loop/01-RESEARCH.md
@.planning/phases/01-core-economy-loop/01-01-SUMMARY.md
@.planning/phases/01-core-economy-loop/01-02-SUMMARY.md
@src/ServerScriptService/Services/GameDirector.lua
@src/ServerScriptService/Services/EconomyManager.lua
@src/ServerScriptService/Services/MonetizationService.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement immediate fail trigger saat cash depleted</name>
  <files>src/ServerScriptService/Services/EconomyManager.lua, src/ServerScriptService/Services/GameDirector.lua</files>
  <action>Tambahkan jalur callback server-authoritative dari EconomyManager ke GameDirector untuk memicu fail event segera saat balance <= 0 di tengah shift (bukan menunggu end-day). Pastikan fail state idempotent agar trigger berulang tidak menimbulkan race condition atau prompt continue ganda.</action>
  <verify>Review kode memastikan setiap mutation saldo kritikal memanggil guard fail dan GameDirector melindungi duplicate fail trigger.</verify>
  <done>Fail flow aktif instan sesuai keputusan user ketika cash habis kapan pun saat shift.</done>
</task>

<task type="auto">
  <name>Task 2: Integrasikan continue purchase dan fallback ke lobby</name>
  <files>src/ServerScriptService/Services/MonetizationService.lua, src/ServerScriptService/Services/GameDirector.lua, src/ServerScriptService/Services/EconomyManager.lua, src/ServerScriptService/Main.server.lua</files>
  <action>Tambahkan API `PromptContinue` dan `ApplyContinueRecovery` di MonetizationService/GameDirector. Recovery harus hanya mengisi cash ke Rp100 tanpa reset state lain. Jika player decline continue, langsung jalankan flow return-to-lobby. Pastikan continue count naik agar pricing policy dari plan 02 terpakai.</action>
  <verify>Periksa jalur logic memiliki dua outcome eksklusif: continue granted -> cash 100, continue declined -> lobby transition.</verify>
  <done>Continue flow dan decline flow berjalan sesuai kontrak user tanpa bonus tersembunyi.</done>
</task>

<task type="auto">
  <name>Task 3: Tambahkan persistence placeholder service dan hook end-of-day</name>
  <files>src/ServerScriptService/Services/PersistenceService.lua, src/ServerScriptService/Main.server.lua, src/ServerScriptService/Services/GameDirector.lua</files>
  <action>Buat PersistenceService placeholder dengan method `LoadPlayerState`, `SavePlayerState`, dan `SaveDaySnapshot` (stub safe + TODO DataStore). Wiring ke Main.server dan panggil save hook minimal saat EndDay agar struktur persistence sudah siap untuk phase eksekusi berikutnya.</action>
  <verify>Pastikan PersistenceService di-require oleh bootstrap dan method save dipanggil di jalur EndDay tanpa crash.</verify>
  <done>Placeholder persistence aktif dan terhubung ke day loop tanpa mengubah scope phase lain.</done>
</task>

</tasks>

<verification>
- [ ] Fail trigger instan saat cash <= 0 sudah terintegrasi.
- [ ] Continue purchase path hanya reset cash ke Rp100.
- [ ] Decline continue mengarah ke lobby.
- [ ] PersistenceService placeholder terhubung pada end-of-day.
</verification>

<success_criteria>
- Loop core economy punya fail/recover path yang lengkap.
- Ketentuan continue Robux dieksekusi server-side dan anti-race.
- Fondasi persistence siap untuk peningkatan phase selanjutnya.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-economy-loop/01-03-SUMMARY.md`
</output>
